# ====================================================================
# DevContainer Makefile - Automa√ß√£o DevOps Avan√ßada
# ====================================================================

.PHONY: help build build-advanced test clean cache-clean deploy dev-up dev-down logs shell benchmark security-scan

# Configura√ß√µes
DOCKER_COMPOSE_FILE := .devcontainer/docker-compose.optimized.yml
ADVANCED_COMPOSE_FILE := .devcontainer/docker-compose.optimized.yml
IMAGE_NAME := dotfiles-dev
REGISTRY := ghcr.io/carloskvasir/dotfiles
BUILD_TIMESTAMP := $(shell date +%Y%m%d_%H%M%S)
GIT_SHA := $(shell git rev-parse --short HEAD 2>/dev/null || echo 'local')

# Colors para output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

# ====================================================================
# TARGETS PRINCIPAIS
# ====================================================================

help: ## üìã Mostra esta mensagem de ajuda
	@echo "$(BLUE)DevContainer Makefile - Automa√ß√£o DevOps Avan√ßada$(NC)"
	@echo "=================================================="
	@echo ""
	@echo "$(GREEN)Targets Dispon√≠veis:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(BLUE)Exemplos de Uso:$(NC)"
	@echo "  make build-advanced    # Build com t√©cnicas avan√ßadas"
	@echo "  make dev-up           # Sobe ambiente de desenvolvimento"
	@echo "  make test             # Executa testes completos"
	@echo "  make benchmark        # Roda benchmark de performance"
	@echo ""

build: ## üèóÔ∏è  Build padr√£o do DevContainer
	@echo "$(YELLOW)üèóÔ∏è  Executando build padr√£o...$(NC)"
	@cd .devcontainer && ./build-production.sh

build-advanced: ## üöÄ Build com t√©cnicas DevOps avan√ßadas
	@echo "$(YELLOW)üöÄ Executando build avan√ßado...$(NC)"
	@chmod +x .devcontainer/build-advanced.sh
	@.devcontainer/build-advanced.sh

build-parallel: ## ‚ö° Build paralelo para m√°xima performance
	@echo "$(YELLOW)‚ö° Executando build paralelo...$(NC)"
	@ENABLE_PARALLEL=true ENABLE_CACHE=true .devcontainer/build-advanced.sh

build-minimal: ## üéØ Build m√≠nimo para testes r√°pidos
	@echo "$(YELLOW)üéØ Executando build m√≠nimo...$(NC)"
	@docker build -f .devcontainer/Dockerfile.optimized --target runtime -t $(IMAGE_NAME):minimal .

# ====================================================================
# AMBIENTE DE DESENVOLVIMENTO
# ====================================================================

dev-up: ## üöÄ Sobe ambiente de desenvolvimento
	@echo "$(GREEN)üöÄ Subindo ambiente de desenvolvimento...$(NC)"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up -d
	@echo "$(GREEN)‚úÖ Ambiente pronto! Acesse via VS Code Remote Containers$(NC)"

dev-down: ## üõë Para ambiente de desenvolvimento
	@echo "$(YELLOW)üõë Parando ambiente de desenvolvimento...$(NC)"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) down

dev-restart: ## üîÑ Reinicia ambiente de desenvolvimento
	@echo "$(YELLOW)üîÑ Reiniciando ambiente...$(NC)"
	@make dev-down
	@make dev-up

dev-rebuild: ## üèóÔ∏è  Reconstroi e reinicia ambiente
	@echo "$(YELLOW)üèóÔ∏è  Reconstruindo ambiente...$(NC)"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) down
	@docker-compose -f $(DOCKER_COMPOSE_FILE) build --no-cache
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up -d

# ====================================================================
# TESTES E VALIDA√á√ÉO
# ====================================================================

test: ## üß™ Executa testes completos
	@echo "$(YELLOW)üß™ Executando testes completos...$(NC)"
	@chmod +x .devcontainer/test-zsh-mise.sh
	@docker run --rm $(IMAGE_NAME):latest /home/vscode/test-zsh-mise.sh

test-integration: ## üîó Testes de integra√ß√£o
	@echo "$(YELLOW)üîó Executando testes de integra√ß√£o...$(NC)"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up -d
	@sleep 10
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec -T devcontainer /bin/zsh -c "source ~/.zshrc && mise --version"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec -T devcontainer /bin/zsh -c "source ~/.zshrc && node --version || echo 'Node not available'"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec -T devcontainer /bin/zsh -c "source ~/.zshrc && python --version || echo 'Python not available'"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) down

test-performance: ## ‚ö° Testes de performance
	@echo "$(YELLOW)‚ö° Executando testes de performance...$(NC)"
	@time docker run --rm $(IMAGE_NAME):latest /bin/zsh -c "source ~/.zshrc && mise list --installed"

validate: ## ‚úÖ Valida configura√ß√µes
	@echo "$(YELLOW)‚úÖ Validando configura√ß√µes...$(NC)"
	@echo "Verificando arquivos obrigat√≥rios..."
	@test -f Dockerfile.optimized || (echo "$(RED)‚ùå Dockerfile.optimized n√£o encontrado$(NC)" && exit 1)
	@test -f docker-compose.optimized.yml || (echo "$(RED)‚ùå docker-compose.optimized.yml n√£o encontrado$(NC)" && exit 1)
	@test -f ../mise/.config/mise/config.toml || (echo "$(RED)‚ùå config.toml n√£o encontrado$(NC)" && exit 1)
	@echo "$(GREEN)‚úÖ Todos os arquivos encontrados$(NC)"

# ====================================================================
# BENCHMARK E PERFORMANCE
# ====================================================================

benchmark: ## üìä Roda benchmark completo
	@echo "$(YELLOW)üìä Executando benchmark completo...$(NC)"
	@echo "=== Container Startup Time ==="
	@time docker run --rm $(IMAGE_NAME):latest echo "Container started"
	@echo ""
	@echo "=== Mise Activation Time ==="
	@time docker run --rm $(IMAGE_NAME):latest /bin/zsh -c "source ~/.zshrc && mise --version"
	@echo ""
	@echo "=== Tool Availability Test ==="
	@docker run --rm $(IMAGE_NAME):latest /bin/zsh -c "source ~/.zshrc && echo 'Node:' && node --version 2>/dev/null || echo 'Not available'"
	@docker run --rm $(IMAGE_NAME):latest /bin/zsh -c "source ~/.zshrc && echo 'Python:' && python --version 2>/dev/null || echo 'Not available'"
	@docker run --rm $(IMAGE_NAME):latest /bin/zsh -c "source ~/.zshrc && echo 'Neovim:' && nvim --version 2>/dev/null | head -1 || echo 'Not available'"

memory-usage: ## üíæ Analisa uso de mem√≥ria
	@echo "$(YELLOW)üíæ Analisando uso de mem√≥ria...$(NC)"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}" $(shell docker ps -q --filter ancestor=$(IMAGE_NAME):latest) 2>/dev/null || echo "Nenhum container rodando"

image-size: ## üìè Mostra tamanhos das imagens
	@echo "$(YELLOW)üìè Tamanhos das imagens:$(NC)"
	@docker images --filter reference=$(IMAGE_NAME) --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"

# ====================================================================
# LIMPEZA E MANUTEN√á√ÉO  
# ====================================================================

clean: ## üßπ Limpeza b√°sica
	@echo "$(YELLOW)üßπ Executando limpeza b√°sica...$(NC)"
	@docker system prune -f
	@docker volume prune -f

cache-clean: ## üóëÔ∏è  Limpeza completa de cache
	@echo "$(YELLOW)üóëÔ∏è  Executando limpeza completa...$(NC)"
	@docker builder prune -f
	@docker image prune -a -f
	@docker volume prune -f
	@docker network prune -f

deep-clean: ## üí£ Limpeza profunda (CUIDADO!)
	@echo "$(RED)üí£ ATEN√á√ÉO: Limpeza profunda remove TUDO!$(NC)"
	@read -p "Tem certeza? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo ""; \
		echo "$(YELLOW)Removendo tudo...$(NC)"; \
		docker system prune -a -f --volumes; \
		docker builder prune -a -f; \
	else \
		echo ""; \
		echo "$(GREEN)Opera√ß√£o cancelada$(NC)"; \
	fi

# ====================================================================
# UTILIT√ÅRIOS
# ====================================================================

shell: ## üêö Acessa shell do container
	@echo "$(YELLOW)üêö Acessando shell do container...$(NC)"
	@docker run -it --rm -v $(PWD):/workspaces/dotfiles $(IMAGE_NAME):latest /bin/zsh

shell-compose: ## üêö Acessa shell via docker-compose
	@echo "$(YELLOW)üêö Acessando shell via compose...$(NC)"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec devcontainer /bin/zsh

logs: ## üìú Mostra logs do container
	@echo "$(YELLOW)üìú Mostrando logs...$(NC)"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) logs -f

status: ## üìä Status do ambiente
	@echo "$(YELLOW)üìä Status do ambiente:$(NC)"
	@echo ""
	@echo "=== Containers ==="
	@docker ps --filter ancestor=$(IMAGE_NAME) --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "=== Volumes ==="
	@docker volume ls --filter name=dotfiles --format "table {{.Name}}\t{{.Driver}}"
	@echo ""
	@echo "=== Images ==="
	@docker images --filter reference=$(IMAGE_NAME) --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

# ====================================================================
# SEGURAN√áA
# ====================================================================

security-scan: ## üîí Executa scan de seguran√ßa
	@echo "$(YELLOW)üîí Executando scan de seguran√ßa...$(NC)"
	@if command -v trivy >/dev/null 2>&1; then \
		trivy image $(IMAGE_NAME):latest; \
	else \
		echo "$(RED)‚ùå Trivy n√£o encontrado. Instale com: sudo apt install trivy$(NC)"; \
	fi

# ====================================================================
# CI/CD e DEPLOY
# ====================================================================

ci-test: ## üîÑ Testes para CI/CD
	@echo "$(YELLOW)üîÑ Executando testes CI/CD...$(NC)"
	@make validate
	@make build-advanced
	@make test
	@make test-integration

deploy: ## üöÄ Deploy para registry
	@echo "$(YELLOW)üöÄ Fazendo deploy para $(REGISTRY)...$(NC)"
	@docker tag $(IMAGE_NAME):latest $(REGISTRY)/devcontainer:latest
	@docker tag $(IMAGE_NAME):latest $(REGISTRY)/devcontainer:$(GIT_SHA)
	@docker push $(REGISTRY)/devcontainer:latest
	@docker push $(REGISTRY)/devcontainer:$(GIT_SHA)
	@echo "$(GREEN)‚úÖ Deploy conclu√≠do!$(NC)"

# ====================================================================
# INFORMA√á√ïES
# ====================================================================

info: ## ‚ÑπÔ∏è  Informa√ß√µes do sistema
	@echo "$(BLUE)‚ÑπÔ∏è  Informa√ß√µes do Sistema$(NC)"
	@echo "=========================="
	@echo "Docker version: $(shell docker --version)"
	@echo "Docker Compose version: $(shell docker-compose --version)"
	@echo "BuildKit version: $(shell docker buildx version 2>/dev/null | head -1 || echo 'Not available')"
	@echo "Git SHA: $(GIT_SHA)"
	@echo "Build Timestamp: $(BUILD_TIMESTAMP)"
	@echo "Registry: $(REGISTRY)"
	@echo "Image Name: $(IMAGE_NAME)"
	@echo ""
	@echo "$(BLUE)Recursos Dispon√≠veis:$(NC)"
	@echo "CPU cores: $(shell nproc)"
	@echo "Memory: $(shell free -h | awk '/^Mem:/ {print $$2}')"
	@echo "Disk space: $(shell df -h . | awk 'NR==2 {print $$4}')"

version: ## üìù Vers√£o e informa√ß√µes do build
	@echo "$(BLUE)DevContainer Build Information$(NC)"
	@echo "=============================="
	@echo "Version: 3.0-advanced"
	@echo "Build Timestamp: $(BUILD_TIMESTAMP)"
	@echo "Git SHA: $(GIT_SHA)"
	@echo "Image: $(IMAGE_NAME):latest"
	@echo "Registry: $(REGISTRY)"
	@echo ""
	@echo "$(GREEN)√öltimas altera√ß√µes:$(NC)"
	@git log --oneline -5 2>/dev/null || echo "Git n√£o dispon√≠vel"

# ====================================================================
# DEFAULT TARGET
# ====================================================================

.DEFAULT_GOAL := help
